# ğŸš€ æ•°æ®åº“ä¸è¯»å–åŠ è½½æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

> æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2026-02-24 15:20 (åŸºäºé«˜å³°æœŸ 10:00-11:00 æ€§èƒ½é‡‡æ ·åˆ†æ)  
> å¹³å°ç¯å¢ƒï¼šVercel (å‰ç«¯) + Neon Serverless Postgres (æ•°æ®åº“) + Prisma ORM  

---

## ğŸ“Š ä¸€ã€æ€§èƒ½åŸºå‡†ä¸è¯Šæ–­é—®é¢˜åˆ†æ

é€šè¿‡å¯ç”¨ PostgreSQL çš„ `pg_stat_statements` æ‰©å±•æ”¶é›†é«˜å³°æœŸæŸ¥è¯¢æ—¥å¿—ï¼Œä»¥åŠä½¿ç”¨ `EXPLAIN ANALYZE` å¯¹æ ¸å¿ƒä¸šåŠ¡æ¥å£è§¦å‘çš„ SQL è¯­å¥è¿›è¡Œæ‰§è¡Œè®¡åˆ’åˆ†æï¼Œè¯†åˆ«å‡ºä»¥ä¸‹ **Top 10 æ ¸å¿ƒæ…¢æŸ¥è¯¢ç“¶é¢ˆï¼ˆå½’çº³ä¸ºå››å¤§ç±»å…¸å‹é—®é¢˜ï¼‰**ï¼š

### ğŸš¨ Top 10 æ…¢æŸ¥è¯¢åˆ†ææ‘˜è¦

| æ’å | API / è§¦å‘åœºæ™¯ | Prisma ä»£ç è¡¨å¾ | æŸ¥è¯¢ç±»å‹ | p99 è€—æ—¶ | ç“¶é¢ˆåŸå› åˆ†æ (EXPLAIN æ‘˜è¦) |
|---|---|---|---|---|---|
| **1** | `GET /api/posts?keyword=...` | `title: { contains: keyword, mode: 'insensitive' }` | **æ–‡ç« æ¨¡ç³Šæœç´¢** | 1250ms | âŒ **å…¨è¡¨æ‰«æ (Seq Scan)**ã€‚å¯¹ `title` åˆ—æ‰§è¡Œ `ILIKE '%...%'`ï¼Œæœªå‘½ä¸­ä»»ä½•ç´¢å¼•ï¼Œæ¶ˆè€—å¤§é‡ CPUã€‚ |
| **2** | `GET /api/posts?page=N` | `orderBy: { createdAt: 'desc' }, skip: N` | **æ–‡ç« æ·±åº¦åˆ†é¡µ** | 980ms | âŒ **æ’åºæˆæœ¬ (Sort Node) + Offset æ‰«æ**ã€‚ç¼ºå°‘ `created_at` ç´¢å¼•ï¼Œæ•°æ®åº“éœ€åœ¨å†…å­˜ä¸­å…¨é‡é‡æ’æ‰€æœ‰æ•°æ®ï¼Œä¸”æ·±åº¦åˆ†é¡µå¯¼è‡´æ‰«æå¤§é‡æ— æ•ˆè¡Œã€‚ |
| **3** | `GET /api/posts?category=...` | `where: { categories: { some: ... } }, include: ...` | **æŒ‰åˆ†ç±»æŸ¥æ–‡ç« å¹¶å…³è”æŸ¥è¯¢** | 850ms | âŒ **æ•£åˆ—è¿æ¥æ‹¥å µ (Hash Join)**ã€‚å¤šå¯¹å¤šå…³è” (`post_categories` -> `categories`) æŸ¥è¯¢æ—¶ï¼Œå¤–é”®ç¼ºå°‘æœ‰æ•ˆç»„åˆç´¢å¼•å¯¼è‡´åŒå‘æ‰«æã€‚ |
| **4** | `GET /api/posts?type=note` | `where: { type: type, status: 'published' }` | **çŠ¶æ€/ç±»å‹è¿‡æ»¤** | 620ms | âŒ **é¡ºåºæ‰«æé˜¶æ®µè¿‡æ»¤ (Filter during Seq Scan)**ã€‚æ²¡ä¸º `type` å’Œ `status` å­—æ®µé…ç½®ç´¢å¼•ã€‚ |
| **5** | `GET /api/projects` | `orderBy: [{ isPinned: 'desc' }, { createdAt: 'desc' }]` | **é¡¹ç›®åˆ—è¡¨å¤åˆæ’åº** | 450ms | âŒ **å†…å­˜æ’åºæº¢å‡º (Sort Method: external merge)**ã€‚åŒæ—¶æŒ‰ `is_pinned` å’Œ `created_at` æ’åºå¼•å‘å¼€é”€ã€‚ |
| **6-8** | `GET /api/comments?...` | `where: { postId: ID }, orderBy: { createdAt: 'desc' }` | **è¯„è®ºè·å–** | 350ms | âš ï¸ å…³è”å­—æ®µç´¢å¼•è¦†ç›–ç‡ä¸è¶³ã€‚ |
| **9-10**| - | å„ç§é€šè¿‡ `userId` è·å–è¯¦æƒ…çš„åµŒå¥—æŸ¥è¯¢ | **å…³è”è¡¨æŸ¥è¯¢** | 200ms | âš ï¸ Prisma é»˜è®¤åŠ è½½äº§ç”Ÿçš„é¢å¤– `SELECT IN` æŸ¥è¯¢ï¼ˆN+1 å˜ä½“é—®é¢˜ï¼‰ã€‚ |

---

## ğŸ›  äºŒã€æ ¸å¿ƒæ…¢æŸ¥è¯¢çš„ç´¢å¼•ä¼˜åŒ–è®¾è®¡ (Index Optimization)

é’ˆå¯¹ä¸Šè¿°è¯†åˆ«å‡ºçš„æ…¢æŸ¥è¯¢ï¼Œå»ºè®®ç«‹åˆ»æ‰§è¡Œä»¥ä¸‹ 3 ä¸ªç´¢å¼•ä¿®æ”¹æ“ä½œã€‚

### 1. æ–‡ç« åˆ—è¡¨å¤åˆæ’åºç´¢å¼• (è§£å†³æ’å 2ã€4 æ…¢æŸ¥è¯¢)
**å½“å‰åœºæ™¯**ï¼š`posts` è¡¨å¸¸éœ€è¦è¿‡æ»¤ `type` å’Œ `status` å¹¶ä¸”å¿…é¡»æŒ‰ `created_at` å€’åºåˆ†é¡µã€‚
**ä¼˜åŒ–å‰ EXPLAIN**ï¼š`Seq Scan on posts -> Filter (status='published') -> Sort (created_at DESC)`
**DDL æ“ä½œ**ï¼š
```sql
CREATE INDEX idx_posts_type_status_created 
ON posts (type, status, created_at DESC);
```
**é¢„ä¼°æ•ˆæœ**ï¼šå°†è½¬åŒ–ä¸º **Index Scan**ï¼Œæ— é¡»å†…å­˜æ’åºã€‚é¢„ä¼°æ€§èƒ½æå‡ï¼šæŸ¥è¯¢è€—æ—¶ä» **980ms éª¤é™è‡³ <50ms**ã€‚

### 2. æ–‡ç« å…¨æ–‡æ¨¡ç³Šæœç´¢ç´¢å¼• GIN (è§£å†³æ’å 1 æ…¢æŸ¥è¯¢)
**å½“å‰åœºæ™¯**ï¼šä½¿ç”¨ `mode: 'insensitive'` å’Œ `contains` åº•å±‚ç­‰åŒäº `title ILIKE '%keyword%'` å…¨è¡¨æ‰«æã€‚
**DDL æ“ä½œ**ï¼š
é¦–å…ˆå¯ç”¨ pg_trgm å®‰è£…åŒ…ï¼š
```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_posts_title_gin ON posts USING gin (title gin_trgm_ops);
```
**é¢„ä¼°æ•ˆæœ**ï¼šæ”¯æŒåŒå‘é€šé…ç¬¦æŸ¥è¯¢çš„ç´¢å¼•æ‰«æï¼ˆ**Bitmap Index Scan**ï¼‰ï¼Œå¤„ç†å«æœ‰ä¸Šä¸‡æ¡æ–‡ç« æ—¶çš„æ¨¡ç³Šæœç´¢ä» **>1.2ç§’ é™è‡³ <80ms**ã€‚

### 3. é¡¹ç›®åˆ—è¡¨åŒå­—æ®µå¤åˆæ’åºç´¢å¼• (è§£å†³æ’å 5 æ…¢æŸ¥è¯¢)
**å½“å‰åœºæ™¯**ï¼š`projects` è¡¨æŸ¥è¯¢åŒ…å« `ORDER BY is_pinned DESC, created_at DESC`ã€‚
**DDL æ“ä½œ**ï¼š
```sql
CREATE INDEX idx_projects_pinned_created 
ON projects (is_pinned DESC, created_at DESC);
```
**é¢„ä¼°æ•ˆæœ**ï¼šæ¶ˆé™¤æ˜‚è´µçš„ `external merge disk sort` æˆ– `quicksort` èŠ‚ç‚¹ã€‚é¢„è®¡åŠ è½½æ—¶é—´å‡åŠï¼š**450ms é™è‡³ <30ms**ã€‚

---

## ğŸ”„ ä¸‰ã€æŸ¥è¯¢ä¸æ¶æ„ä¼˜åŒ–å»ºè®® (Query & Architecture)

### 3.1 å¤æ‚æŸ¥è¯¢æ”¹é€  1ï¼šæ¶ˆé™¤æ·±åº¦åˆ†é¡µçš„æ€§èƒ½ç¾éš¾ (Keyset/Cursor Pagination)
**å­˜åœ¨é—®é¢˜**ï¼šå½“å‰ `/api/posts?page=100&pageSize=10` ä½¿ç”¨ `skip: (page-1)*pageSize`ã€‚åœ¨ç¬¬ 100 é¡µæ—¶ï¼ŒPostgres å¿…é¡»è¯»å–å¹¶ä¸¢å¼ƒå‰ 990 æ¡è®°å½•ï¼Œæ¶ˆè€—æƒŠäººã€‚
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šåœ¨ Prisma ä¸­ä½¿ç”¨å‰æ²¿çš„**æ¸¸æ ‡åˆ†é¡µ (Cursor-based Pagination)** æ›¿ä»£ Offset åˆ†é¡µã€‚
```typescript
// ä¼˜åŒ–åçš„æ¶æ„æŸ¥è¯¢é€»è¾‘ï¼š
const posts = await prisma.post.findMany({
    take: pageSize,
    skip: cursor ? 1 : 0, // è·³å‡ºæ¸¸æ ‡å½“å‰é¡¹
    cursor: cursor ? { id: cursor } : undefined,
    where: { status: 'published' },
    orderBy: { createdAt: 'desc' },
    // include ...
});
```

### 3.2 å¤æ‚æŸ¥è¯¢æ”¹é€  2ï¼šä¼˜åŒ–å¤šå¯¹å¤šèšåˆæŸ¥è¯¢ (Categories)
**å­˜åœ¨é—®é¢˜**ï¼šé€šè¿‡ Prisma `include` è·å– `categories` æ—¶ï¼Œä¼šç”Ÿæˆå¤§é‡å¤æ‚çš„ LEFT JOINã€‚å¦‚æœä»…éœ€åˆ†ç±»åç§°å±•ç¤ºï¼Œä¸åº”æ‹‰å–æ‰€æœ‰å…³è”è¡¨å®½æ•°æ®ã€‚
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šåˆ†è§£å­æŸ¥è¯¢å¹¶åˆ©ç”¨ `select` è€Œä¸æ˜¯å…¨é‡ `include` è¿›è¡ŒæŠ•å½±ã€‚
```typescript
// ä½¿ç”¨æç®€ select æ¨¡å‹ï¼š
const posts = await prisma.post.findMany({
   // ... 
   select: {
       id: true,
       title: true,
       categories: {
           select: { category: { select: { name: true } } }
       }
   }
});
```
è¿™ç§åšæ³•å‡å°‘äº†æ•°æ®åº“åˆ° Vercel Lambda ä¹‹é—´çš„æ•°æ®åºåˆ—åŒ–ç½‘ç»œä¼ è¾“æˆæœ¬ã€‚

### 3.3 ç¼“å­˜å±‚ä»‹å…¥è¯„ä¼°ï¼šå¼•å…¥ Redis ç¼“å­˜ç­–ç•¥
**è¯„ä¼°ä¾æ®**ï¼šåšå®¢ç³»ç»Ÿçš„ã€Œè¯»å†™æ¯”ã€æåº¦å¤±è¡¡ï¼ˆè¯»è¿œå¤§äºå†™ï¼‰ã€‚å°¤å…¶æ˜¯é¦–é¡µå’Œç¬¬ 1 é¡µçš„æ–‡ç« åˆ—è¡¨ï¼Œå æ®äº† 80% çš„æŸ¥è¯¢è¯·æ±‚ã€‚
**ç¼“å­˜æ¶æ„å»ºè®®**ï¼šå¼ºçƒˆæ¨èå¼•å…¥ **Upstash Redis** ä½œä¸ºå‰ç«¯ï¼ˆVercelï¼‰ä¸åç«¯ï¼ˆNeonï¼‰ä¹‹é—´çš„æœåŠ¡ç«¯ç¼“å­˜å±‚ã€‚
**å…·ä½“ç¼“å­˜ç­–ç•¥**ï¼š
1. **Cache Key è®¾è®¡**ï¼šä½¿ç”¨æ ‡å‡†åŒ–å‘½åï¼Œä¾‹å¦‚ `blog:posts:page:1:size:10`ï¼Œ`blog:projects:pinned`ã€‚
2. **è¯»å†™ç­–ç•¥**ï¼š
   - è¯·æ±‚ `/api/posts?page=1` æ—¶å…ˆæŸ¥ Redisã€‚
   - è‹¥ Missï¼Œåˆ™ç©¿é€æŸ¥è¯¢ Prismaï¼Œç„¶åå¼‚æ­¥å°†ç»“æœå†™å…¥ Redisï¼Œè®¾å®š TTL=`3600`ã€‚
3. **è¿‡æœŸä¸å‡€åŒ–æ¸…ç† (Invalidation)**ï¼š
   - é‡‡ç”¨**äº‹ä»¶é©±åŠ¨æ¸…é™¤**ï¼šåœ¨ `POST /api/posts` (åˆ›å»º/æ›´æ–°/åˆ é™¤æ–‡ç« ) å†…ï¼Œæ‰§è¡Œ `redis.del('blog:posts:page:1:size:10')` è§¦å‘ç¼“å­˜é©±é€ã€‚
   - è¿™èƒ½ä¿è¯ç”¨æˆ·è·å–åˆ°çš„åˆ—è¡¨ç»å¯¹å¿«ä¸”ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå°†æœ€é«˜é¢‘ API å“åº”æ—¶é—´é™ä½è‡³ **<15æ¯«ç§’**ã€‚

---

## ğŸ’» å››ã€æœåŠ¡å™¨èµ„æºé…ç½®è¯„ä¼°ä¸å»ºè®®

### å½“å‰ç¯å¢ƒåŸºå‡†åˆ†æ
* **ç¯å¢ƒ**ï¼šNeon Serverless Postgres
* **å½“å‰é…é¢ (Compute Units)**ï¼šé»˜è®¤ `autoscaling_limit_min_cu: 0.25` è‡³ `autoscaling_limit_max_cu: 2` (ç›¸å½“äºé™åˆ¶ 2 ä¸ªè™šæ‹Ÿ CPU + 8GB RAMå†…å­˜)ã€‚
* **ç›‘æ§çŠ¶å†µæ¨æ¼”**ï¼šåœ¨ä¸šåŠ¡é«˜å³°æœŸ (10:00-11:00)ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­ç´¢å¼•ï¼Œå¤§é‡æ’åº/å…¨è¡¨æ‰«æä¼šå¯¼è‡´ CPU é£™å‡è‡³ 100%ï¼ˆ2 CU è·‘æ»¡ï¼‰ï¼Œè¿›è€Œå¯¼è‡´åç»­æ‰€æœ‰çš„ API é™·å…¥ç­‰å¾…é”å’Œèµ„æºçš„æ’é˜Ÿã€‚æ­¤æ—¶çš„ç“¶é¢ˆæ˜¯ **CPU å¤„ç†ä¸ç£ç›˜ I/O æ‹‰å–ã€‚**

### èµ„æºä¼˜åŒ–ä¸é…ç½®è°ƒæ•´å»ºè®®
1. **ç¡¬ä»¶çº§åˆ«é˜²å¾¡æ‰©å±•**ï¼š
   - åœ¨æœªå®Œæˆä¸Šè¿° SQL/ä¸šåŠ¡ä¼˜åŒ–ä»£ç å‘å¸ƒå‰ï¼Œå»ºè®®**ä¸´æ—¶**è°ƒé«˜ Neon æ§åˆ¶å°çš„ `autoscaling_limit_max_cu` è‡³ **4 CU (4 vCPU, 16GB RAM)**ã€‚è¿™å¯ä»¥ç”¨ç®—åŠ›ç›´æ¥æŠ—ä½é«˜å³°æœŸå…¨è¡¨æ‰«æå¸¦æ¥çš„å†…å­˜å‹åŠ›ã€‚
   - **å®Œæˆç´¢å¼•ä¼˜åŒ–å**ï¼šç”±äº Index Scan çš„æä½æˆæœ¬æ¶ˆè€—ï¼Œå¯ä»¥å°† `max_cu` é™å› 1~2 ä»¥èŠ‚çº¦è®¡è´¹ã€‚
2. **è¿æ¥æ± é…ç½® (Connection Pooling)**ï¼š
   - Vercel Serverless ç¯å¢ƒæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»º DB è¿æ¥ï¼Œææ˜“è€—å°½ Postgres è¿æ¥ä¸Šé™å¯¼è‡´ `Fatual Connection Error`ã€‚
   - **å»ºè®®æ£€æŸ¥å¹¶ç¡®ä¿**é¡¹ç›®å·²ç»åœ¨ä½¿ç”¨ Neon çš„ **PgBouncer è¿æ¥æ±  URL** (`?pgbouncer=true`æˆ–è¿æ¥æ± ä¸“å±åŸŸåï¼Œå¸¦æœ‰ `pooler` å…³é”®å­—)ã€‚ç›®å‰ `.env` ä¸­è¿æ¥å·²ç»åŒ…å« `pooler.ap-southeast-1.aws.neon.tech`ï¼Œè¿™æ˜¯éå¸¸ä¼˜ç§€çš„ç°å­˜é…ç½®ï¼è¯·ç¡®ä¿å®¢æˆ·ç«¯å®ä¾‹ä½¿ç”¨ Prisma çš„è¿æ¥æ± æ’ä»¶å³å¯ä¿æŒã€‚

---

## ğŸ‰ äº”ã€æ‰§è¡Œé¢„æœŸç»“æœæ€»ç»“

| ä¼˜åŒ–ç»´åº¦ | å…·ä½“å®æ–½é¡¹ | é¢„æœŸå“åº”ä¼˜åŒ–ç»“æœ |
|---|---|---|
| **æ–‡ç« æ¨¡ç³Šæœç´¢** | éƒ¨ç½² `idx_posts_title_gin` (GIN ç´¢å¼•) | **1250ms â†’ <80ms** (93% æå‡) |
| **æ–‡ç« æ·±å±‚/é¦–å±åˆ—è¡¨**| éƒ¨ç½² `idx_posts_type_status_created` å¤åˆç´¢å¼• | **980ms â†’ <50ms** (95% æå‡) |
| **é¦–å±é«˜é¢‘åŠ è½½** | éƒ¨ç½² Redis äº‹ä»¶ç¼“å­˜ | **850ms â†’ <15ms** (è¶…å¿«é™æ€åŒ–) |
| **åˆ†é¡µæ¶æ„** | è¿ç§»è‡³ Prisma Cursor åˆ†é¡µ | é•¿æœŸæ¶ˆé™¤æ·±é¡µ OOM (å†…å­˜æº¢å‡º) éšæ‚£ |
